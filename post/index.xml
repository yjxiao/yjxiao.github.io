<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on Yijun&#39;s homepage</title>
    <link>http://yjxiao.github.io/post/</link>
    <description>Recent content in Posts on Yijun&#39;s homepage</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Wed, 03 Feb 2016 14:02:37 +0200</lastBuildDate>
    <atom:link href="http://yjxiao.github.io/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>AWS EC2 Cluster Setup with Per Instance Usage Control</title>
      <link>http://yjxiao.github.io/post/setup-ec2-with-usage-control/</link>
      <pubDate>Wed, 03 Feb 2016 14:02:37 +0200</pubDate>
      
      <guid>http://yjxiao.github.io/post/setup-ec2-with-usage-control/</guid>
      <description>

&lt;p&gt;This semester we have to set up a EC2 GPU cluster for students enrolled in the deep learning class. With a hard limit on the spendings, we have to control the access of each team based on their resource usage.&lt;/p&gt;

&lt;h3 id=&#34;iam-users:549e1a9f337660c8d2241dd0edf7dded&#34;&gt;IAM Users&lt;/h3&gt;

&lt;p&gt;First things first, create a user for each student (or team). We can assign an auto-generated password for each user in the &lt;em&gt;Security Credentials&lt;/em&gt; tab. This will generate a password along with a sign-in link. You might need to modify the account settings to allow users to change their own password.&lt;/p&gt;

&lt;h3 id=&#34;iam-groups-and-policies:549e1a9f337660c8d2241dd0edf7dded&#34;&gt;IAM Groups and Policies&lt;/h3&gt;

&lt;p&gt;Next, create a group for each team and add the corresponding users to the group. In our case, we restrict each team to a specific instance and only grant them the &lt;em&gt;StartInstances&lt;/em&gt; and &lt;em&gt;StopInstances&lt;/em&gt; access. In other words, students cannot launch new instances or terminate the existing ones. Below is an example policy to do exactly this. Users still need &lt;em&gt;AmazonEC2ReadOnlyAccess&lt;/em&gt; to describe available EC2 instances.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
    &amp;quot;Version&amp;quot;: &amp;quot;2012-10-17&amp;quot;,
    &amp;quot;Statement&amp;quot;: [
        {
            &amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;,
            &amp;quot;Action&amp;quot;: [
                &amp;quot;ec2:StartInstances&amp;quot;,
                &amp;quot;ec2:StopInstances&amp;quot;
            ],
            &amp;quot;Resource&amp;quot;: &amp;quot;arn:aws:ec2:us-west-2:ACCOUNT-ID:instance/INSTANCE-ID&amp;quot;
        },
        {
            &amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;,
            &amp;quot;Action&amp;quot;: &amp;quot;ec2:CreateKeyPair&amp;quot;,
            &amp;quot;Resource&amp;quot;: &amp;quot;*&amp;quot;
        }
    ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;An example policy that allows user to start and stop instances as well as create key pairs.&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&#34;launch-instances-and-create-key-pairs:549e1a9f337660c8d2241dd0edf7dded&#34;&gt;Launch Instances and Create Key Pairs&lt;/h3&gt;

&lt;p&gt;Apparently, we have to launch an instance for each group and specify the instance ARN (aka. &lt;em&gt;Resource&lt;/em&gt;) in the corresponding policy. When creating the instance, attach a tag with the team name for better identification.&lt;/p&gt;

&lt;p&gt;A key pair is required when we launch an instance. So rather than granting teams access to creating new key pairs as shown in the example policy, it is easier to create a key pair for each team and distribute the private keys to them. In this way, you don&amp;rsquo;t need to wait till a certain student create her key pairs to assign instance to her. Note that private keys need to have maximum(?) permission &lt;code&gt;600&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;For later use, you also need to create an instance role that grants the access to writing data to &lt;em&gt;CloudWatch&lt;/em&gt; as well as describing its own tags. Select this role while launching the instances.&lt;/p&gt;

&lt;h3 id=&#34;monitor-instance-usages:549e1a9f337660c8d2241dd0edf7dded&#34;&gt;Monitor Instance Usages&lt;/h3&gt;

&lt;p&gt;There is no real time spending (as in $) monitoring available on AWS. As a result, we need to estimate the maximum hours we can afford for each instance and keep track of each instance&amp;rsquo;s running time. Students need to stop their assigned instance whenever the idle time is longer than 2 hours. Note that Amazon charges a full hour whenever you start a stopped instance!&lt;/p&gt;

&lt;p&gt;On each instance, create two scripts. The first script is used to count the number of running hours. Schedule the script to be executed every hour.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash
COUNT_FILE=/home/ec2-user/.monitor/hours_run
echo $(($(cat $COUNT_FILE) + 1)) &amp;gt; $COUNT_FILE
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The second script is used to compute the usage and write data to &lt;em&gt;CloudWatch&lt;/em&gt;. This also needs to be scheduled at least once per hour depending on your intended update interval.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash
# compute the percentage of total hours consumed
COUNT_FILE=/home/ec2-user/.monitor/hours_run
HOURS_RUN=$(cat $COUNT_FILE)
HOURS_MAX=200
PERCENT_CONSUMED=$(echo &amp;quot;scale=2;$HOURS_RUN/$HOURS_MAX&amp;quot; | bc)
# request instance id
INSTANCE_ID=$(curl http://169.254.169.254/latest/meta-data/instance-id)
# describe its own tags to get team name
TEAM_ID=$(aws ec2 describe-tags --region us-west-2 --filters Name=resource-id,Values=&amp;quot;$INSTANCE_ID&amp;quot; Name=key,Values=Team --query Tags[0].Value | sed s/\&amp;quot;//g)&amp;quot;
# please delete the last double quote in the above line
# write the usage percentage to a cloudwatch metric
aws cloudwatch put-metric-data --namespace &amp;quot;NYUCDS/GPULab&amp;quot; --name &amp;quot;BudgetConsumed&amp;quot; --dimensions &amp;quot;Team=$TEAM_ID&amp;quot; --unit Percent --value $PERCENT_CONSUMED
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;cloudwatch-alarm-and-action:549e1a9f337660c8d2241dd0edf7dded&#34;&gt;CloudWatch Alarm and Action&lt;/h3&gt;

&lt;p&gt;Once you make sure the custom metric is updated normally. Simply set up an alarm when the metric reaches a threshold. Once triggered, this will send the admins email notifications and take certain actions (e.g. terminate the instance).&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>